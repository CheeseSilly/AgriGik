<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI æ™ºèƒ½åŠ©æ‰‹ - ç°ä»£åŒ–ç‰ˆæœ¬</title>

    <!-- å¼•å…¥ç°ä»£åŒ–CSSæ ·å¼ -->
    <link rel="stylesheet" href="styles.css" />

    <!-- å¼•å…¥ Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>

    <!-- å¼•å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Tailwind é…ç½® -->
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: {
                DEFAULT: "#10b981",
                dark: "#059669",
                light: "#34d399",
              },
              secondary: {
                DEFAULT: "#14b8a6",
                dark: "#0d9488",
                light: "#2dd4bf",
              },
              accent: {
                DEFAULT: "#06b6d4",
                dark: "#0891b2",
                light: "#22d3ee",
              },
            },
          },
        },
      };
    </script>
  </head>

  <body class="animated-bg transition-colors duration-300">
    <!-- ä¸»é¢˜åˆ‡æ¢æŒ‰é’®(dark mode) -->
    <div class="fixed top-4 right-4 z-50">
      <button
        id="themeToggle"
        onclick="toggleTheme()"
        class="p-3 rounded-full bg-white/20 backdrop-blur-md border border-white/30 hover:bg-white/30 transition-all duration-300 shadow-lg"
        title="åˆ‡æ¢ä¸»é¢˜"
      >
        <svg
          id="sunIcon"
          class="w-5 h-5 text-yellow-400 hidden dark:block"
          fill="currentColor"
          viewBox="0 0 20 20"
        >
          <path
            fill-rule="evenodd"
            d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z"
            clip-rule="evenodd"
          ></path>
        </svg>
        <svg
          id="moonIcon"
          class="w-5 h-5 text-slate-400 block dark:hidden"
          fill="currentColor"
          viewBox="0 0 20 20"
        >
          <path
            d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"
          ></path>
        </svg>
      </button>
    </div>

    <!-- ä¸»è¦æ¼”ç¤ºå†…å®¹(skip) -->

    <!-- AIåŠ©æ‰‹æµ®åŠ¨æŒ‰é’® -->
    <div class="ai-assistant-widget">
      <!-- ä¸»æŒ‰é’® -->
      <button id="aiButton" onclick="toggleMiniChat()" class="btn-floating">
        <div class="pulse-ring"></div>
        <div class="floating-content">
          <img
            class="floating-icon"
            src="chat-ui-svgrepo-com.svg"
            alt="Chat Icon"
          />
          <span class="floating-text">é—®AI</span>
        </div>
        <!-- é€šçŸ¥å¾½ç«  -->
        <div id="aiBadge" class="notification-badge hidden">1</div>
      </button>

      <!-- è¿·ä½ èŠå¤©çª—å£ -->
      <div id="aiMiniChat" class="chat-container">
        <!-- å¤´éƒ¨ -->
        <div class="chat-header">
          <div class="chat-title">
            <svg
              class="icon text-white"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
            >
              <path d="M9 12l2 2 4-4" />
              <path d="M21 12c-1 0-3-1-3-3s2-3 3-3 3 1 3 3-2 3-3 3" />
              <path d="M3 12c1 0 3-1 3-3s-2-3-3-3-3 1-3 3 2 3 3 3" />
              <path d="M12 3c0 1-1 3-3 3s-3-2-3-3 1-3 3-3 3 2 3 3" />
              <path d="M12 21c0-1 1-3 3-3s3 2 3 3-1 3-3 3-3-2-3-3" />
            </svg>
            AI åŠ©æ‰‹
          </div>
          <div class="chat-actions">
            <button
              class="chat-action-btn"
              onclick="openFullscreen()"
              title="å…¨å±æ¨¡å¼"
            >
              <svg
                class="icon-sm"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
              >
                <path
                  d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"
                />
              </svg>
            </button>
            <button
              class="chat-action-btn"
              onclick="toggleMiniChat()"
              title="å…³é—­"
            >
              <svg
                class="icon-sm"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
              >
                <line x1="18" y1="6" x2="6" y2="18" />
                <line x1="6" y1="6" x2="18" y2="18" />
              </svg>
            </button>
          </div>
        </div>

        <!-- æ¶ˆæ¯åŒºåŸŸ -->
        <div id="aiMiniMessages" class="chat-messages">
          <div class="message ai">
            <div class="message-avatar ai">
              <img
                class="icon text-white relative z-10"
                src="chat-ui-svgrepo-com.svg"
                alt="Chat Icon"
              />
            </div>
            <div class="message-content">
              ğŸ‘‹ æ‚¨å¥½ï¼æˆ‘æ˜¯è°·ç¨·ï¼Œæœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©æ‚¨çš„å—ï¼Ÿ
            </div>
          </div>

          <!-- è¿·ä½ é¢„è®¾é—®é¢˜ -->
          <div class="mini-example-questions" id="miniExampleQuestions">
            <div class="mini-questions-header">
              <span>å†œä¸šé—®é¢˜å’¨è¯¢</span>
            </div>
            <div class="mini-questions-list">
              <button
                class="mini-question"
                onclick="selectMiniExampleQuestion(this)"
                data-question="æˆ‘çš„ç•ªèŒ„å¶å­ä¸Šå‡ºç°é»„è‰²æ–‘ç‚¹ï¼Œå¯èƒ½æ˜¯ä»€ä¹ˆç—…å®³ï¼Ÿ"
              >
                ğŸ… ä½œç‰©ç—…è™«å®³è¯Šæ–­
              </button>
              <button
                class="mini-question"
                onclick="selectMiniExampleQuestion(this)"
                data-question="ç°åœ¨7æœˆä»½ï¼Œå¹¿ä¸œåœ°åŒºé€‚åˆç§æ¤ä»€ä¹ˆè”¬èœï¼Ÿ"
              >
                ğŸŒ± ç§æ¤æ—¶é—´å’¨è¯¢
              </button>
              <button
                class="mini-question"
                onclick="selectMiniExampleQuestion(this)"
                data-question="åœŸå£¤æ¹¿åº¦ä¼ æ„Ÿå™¨æ˜¾ç¤ºæ•°å€¼å¼‚å¸¸ï¼Œå¦‚ä½•æ’æŸ¥é—®é¢˜ï¼Ÿ"
              >
                ï¿½ æ•°æ®å¼‚å¸¸åˆ†æ
              </button>
              <button
                class="mini-question"
                onclick="selectMiniExampleQuestion(this)"
                data-question="å¦‚ä½•åˆ¶å®šç§‘å­¦çš„æ°´è‚¥ä¸€ä½“åŒ–çŒæº‰æ–¹æ¡ˆï¼Ÿ"
              >
                ğŸ’§ çŒæº‰æ–½è‚¥æŒ‡å¯¼
              </button>
            </div>
          </div>
        </div>

        <!-- è¾“å…¥åŒºåŸŸ -->
        <div class="chat-input">
          <div class="input-container">
            <input id="aiMiniInput" type="text" placeholder="è¾“å…¥æ‚¨çš„é—®é¢˜..." />
            <button onclick="sendMiniMessage()" class="send-btn">
              <svg
                class="icon-sm"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
              >
                <line x1="22" y1="2" x2="11" y2="13" />
                <polygon points="22,2 15,22 11,13 2,9 22,2" />
              </svg>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- å…¨å±æ¨¡æ€æ¡† -->
    <div id="aiModal" class="fullscreen-modal">
      <!-- å¤´éƒ¨ -->
      <div class="fullscreen-header">
        <div class="fullscreen-title">
          <svg
            class="icon-lg text-white"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
          >
            <path d="M9 12l2 2 4-4" />
            <path d="M21 12c-1 0-3-1-3-3s2-3 3-3 3 1 3 3-2 3-3 3" />
            <path d="M3 12c1 0 3-1 3-3s-2-3-3-3-3 1-3 3 2 3 3 3" />
            <path d="M12 3c0 1-1 3-3 3s-3-2-3-3 1-3 3-3 3 2 3 3" />
            <path d="M12 21c0-1 1-3 3-3s3 2 3 3-1 3-3 3-3-2-3-3" />
          </svg>
          AI æ™ºèƒ½åŠ©æ‰‹
        </div>
        <div class="fullscreen-actions">
          <button
            onclick="handleHeaderButtonClick(event, 'toggleSidebar')"
            class="btn btn-secondary"
          >
            <svg
              class="icon"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
            >
              <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" />
              <polyline points="9,22 9,12 15,12 15,22" />
            </svg>
            å†å²è®°å½•
          </button>
          <button
            onclick="handleHeaderButtonClick(event, 'exportAllHistory')"
            class="btn btn-secondary"
          >
            <svg
              class="icon"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
            >
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
              <polyline points="7,10 12,15 17,10" />
              <line x1="12" y1="15" x2="12" y2="3" />
            </svg>
            å¯¼å‡ºå†å²
          </button>
          <button
            onclick="handleHeaderButtonClick(event, 'closeFullscreen')"
            class="btn btn-secondary"
            type="button"
          >
            <svg
              class="icon"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
            >
              <line x1="18" y1="6" x2="6" y2="18" />
              <line x1="6" y1="6" x2="18" y2="18" />
            </svg>
            å…³é—­
          </button>
        </div>
      </div>

      <!-- ä¸»è¦å†…å®¹ -->
      <div class="fullscreen-content">
        <!-- ä¾§è¾¹æ  -->
        <div id="aiSidebar" class="sidebar">
          <div class="sidebar-header">
            <button onclick="startNewChat()" class="btn btn-primary w-full">
              <svg
                class="icon"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
              >
                <line x1="12" y1="5" x2="12" y2="19" />
                <line x1="5" y1="12" x2="19" y2="12" />
              </svg>
              æ–°å»ºå¯¹è¯
            </button>
            <div class="sidebar-menu">
              <button
                onclick="clearAllHistory()"
                class="btn btn-secondary btn-sm w-full mt-2"
                title="æ¸…ç©ºæ‰€æœ‰å†å²è®°å½•"
              >
                <svg
                  class="icon"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                >
                  <polyline points="3,6 5,6 21,6"></polyline>
                  <path
                    d="m19,6v14a2,2 0 0,1 -2,2H7a2,2 0 0,1 -2,-2V6m3,0V4a2,2 0 0,1 2,-2h4a2,2 0 0,1 2,2v2"
                  ></path>
                </svg>
                æ¸…ç©ºå†å²
              </button>
            </div>
          </div>
          <div id="aiHistoryList" class="sidebar-content">
            <!-- å†å²è®°å½•å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
          </div>
        </div>

        <!-- ä¸»èŠå¤©åŒºåŸŸ -->
        <div class="main-chat">
          <!-- æ¶ˆæ¯åŒºåŸŸ -->
          <div id="aiFullMessages" class="main-messages">
            <div class="message ai">
              <div class="message-avatar ai">
                <img
                  class="icon text-white relative z-10"
                  src="chat-ui-svgrepo-com.svg"
                  alt="Chat Icon"
                />
              </div>
              <div class="message-content">
                ğŸ‘‹
                æ¬¢è¿ä½¿ç”¨AIæ™ºèƒ½åŠ©æ‰‹ï¼æˆ‘å¯ä»¥å¸®åŠ©æ‚¨è§£ç­”é—®é¢˜ã€åˆ†ææ–‡æ¡£ã€è¿›è¡Œåˆ›æ„æ€è€ƒç­‰ã€‚è¯·éšæ—¶å‘æˆ‘æé—®ã€‚
              </div>
            </div>

            <!-- é¢„è®¾é—®é¢˜åŒºåŸŸ -->
            <div class="example-questions" id="exampleQuestions">
              <div class="example-questions-header">
                <h3>æ™ºæ…§å†œä¸šåŠ©æ‰‹</h3>
              </div>
              <div class="example-questions-grid">
                <button
                  class="example-question"
                  onclick="selectExampleQuestion(this)"
                  data-question="æˆ‘çš„ç•ªèŒ„å¶ç‰‡èƒŒé¢å‡ºç°äº†å¾ˆå¤šç™½è‰²å°é£è™«ï¼Œåº”è¯¥å¦‚ä½•é˜²æ²»ï¼Ÿ"
                >
                  <div class="question-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                      <path
                        d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2z"
                      />
                      <path d="M8 12l2 2 4-4" />
                    </svg>
                  </div>
                  <div class="question-text">
                    <span class="question-title">ç—…è™«å®³æ™ºèƒ½è¯Šæ–­</span>
                    <span class="question-desc"
                      >è¯†åˆ«ä½œç‰©ç—…å®³ï¼Œæä¾›é˜²æ²»æ–¹æ¡ˆ</span
                    >
                  </div>
                </button>

                <button
                  class="example-question"
                  onclick="selectExampleQuestion(this)"
                  data-question="æˆ‘åœ¨å¹¿ä¸œï¼Œç°åœ¨7æœˆä»½é€‚åˆç§ä»€ä¹ˆè”¬èœï¼Ÿè¯·ç»™å‡ºè¯¦ç»†çš„ç§æ¤å»ºè®®ã€‚"
                >
                  <div class="question-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                      <path
                        d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707"
                      />
                      <circle cx="12" cy="12" r="5" />
                    </svg>
                  </div>
                  <div class="question-text">
                    <span class="question-title">ç§æ¤å†³ç­–æ”¯æŒ</span>
                    <span class="question-desc">æ ¹æ®åœ°åŒºå’Œå­£èŠ‚æ¨èä½œç‰©</span>
                  </div>
                </button>

                <button
                  class="example-question"
                  onclick="selectExampleQuestion(this)"
                  data-question="Aåœ°å—çš„åœŸå£¤æ¹¿åº¦åœ¨è¿‡å»3å°æ—¶å†…ä¸‹é™äº†50%ï¼Œå¯èƒ½æ˜¯ä»€ä¹ˆåŸå› ï¼Ÿ"
                >
                  <div class="question-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                      <path d="M3 3v18h18" />
                      <path d="m7 16 4-4 4 4 4-4" />
                    </svg>
                  </div>
                  <div class="question-text">
                    <span class="question-title">æ•°æ®å¼‚å¸¸è§£è¯»</span>
                    <span class="question-desc">åˆ†æä¼ æ„Ÿå™¨æ•°æ®æ³¢åŠ¨åŸå› </span>
                  </div>
                </button>

                <button
                  class="example-question"
                  onclick="selectExampleQuestion(this)"
                  data-question="å¦‚ä½•ä¸ºç‰ç±³åˆ¶å®šç§‘å­¦çš„æ°´è‚¥ä¸€ä½“åŒ–çŒæº‰æ–¹æ¡ˆï¼Ÿ"
                >
                  <div class="question-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                      <path
                        d="M7 16.3c2.2 0 4-1.8 4-4 0-1.5-.7-2.9-1.9-3.7-.6-.4-1.1-.7-1.1-1.4 0-.4.2-.8.4-1.1C9.1 5.4 10 5 11 5c.6 0 1.2.1 1.8.3"
                      />
                      <path d="m11 2-1 2 1 2 1-2-1-2" />
                      <path d="M19.07 4.93A10 10 0 0 0 12 2" />
                      <path d="M12 10a2 2 0 0 0-2 2c0 1.02-.1 2.51-.26 4" />
                      <path d="m14 14 1-1 1 1-1 1-1-1" />
                    </svg>
                  </div>
                  <div class="question-text">
                    <span class="question-title">çŒæº‰æ–½è‚¥æŒ‡å¯¼</span>
                    <span class="question-desc">åˆ¶å®šæ°´è‚¥ç®¡ç†æ–¹æ¡ˆ</span>
                  </div>
                </button>

                <button
                  class="example-question"
                  onclick="selectExampleQuestion(this)"
                  data-question="å¦‚ä½•é€šè¿‡æ™ºèƒ½è®¾å¤‡ç›‘æµ‹å¤§æ£šå†…çš„æ¸©æ¹¿åº¦å’Œå…‰ç…§æ¡ä»¶ï¼Ÿ"
                >
                  <div class="question-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                      <rect x="2" y="4" width="20" height="16" rx="2" />
                      <path d="m22 6-10 6L2 6" />
                    </svg>
                  </div>
                  <div class="question-text">
                    <span class="question-title">æ™ºèƒ½è®¾å¤‡åº”ç”¨</span>
                    <span class="question-desc">ç¯å¢ƒç›‘æµ‹ä¸è‡ªåŠ¨åŒ–æ§åˆ¶</span>
                  </div>
                </button>

                <button
                  class="example-question"
                  onclick="selectExampleQuestion(this)"
                  data-question="åˆ†ææˆ‘å†œåœºçš„äº§é‡æ•°æ®ï¼Œç»™å‡ºå¢äº§å»ºè®®å’Œä¼˜åŒ–æ–¹æ¡ˆã€‚"
                >
                  <div class="question-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                      <path d="M3 3v18h18" />
                      <path d="M7 12v4" />
                      <path d="M12 8v8" />
                      <path d="M17 4v12" />
                    </svg>
                  </div>
                  <div class="question-text">
                    <span class="question-title">äº§é‡æ•°æ®åˆ†æ</span>
                    <span class="question-desc">æ•°æ®é©±åŠ¨çš„å¢äº§ç­–ç•¥</span>
                  </div>
                </button>
              </div>
            </div>
          </div>

          <!-- è¾“å…¥åŒºåŸŸ -->
          <div class="main-input-area">
            <!-- æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ -->
            <div id="aiUploadArea" class="upload-area">
              <svg
                class="icon text-gray-500 mx-auto mb-2"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
              >
                <path
                  d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"
                />
                <polyline points="14,2 14,8 20,8" />
                <line x1="16" y1="13" x2="8" y2="13" />
                <line x1="16" y1="17" x2="8" y2="17" />
                <polyline points="10,9 9,9 8,9" />
              </svg>
              <p class="text-gray-600">ç‚¹å‡»æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„ä¸Šä¼ </p>
              <p class="text-sm text-gray-500 mt-1">æ”¯æŒå¤šç§æ–‡ä»¶æ ¼å¼</p>
            </div>

            <input
              type="file"
              id="fullFileInput"
              class="hidden"
              onchange="handleFullFileUpload(event)"
              multiple
            />

            <!-- å·²ä¸Šä¼ æ–‡ä»¶åˆ—è¡¨ -->
            <div id="aiUploadedFiles" class="uploaded-files"></div>

            <!-- è¾“å…¥æ¡† -->
            <div class="main-input-container">
              <textarea
                id="aiFullInput"
                placeholder="è¾“å…¥æ‚¨çš„é—®é¢˜... (Shift+Enter æ¢è¡Œ)"
                class="main-input"
                rows="1"
              ></textarea>
              <div class="input-actions">
                <button
                  onclick="document.getElementById('fullFileInput').click()"
                  class="input-action-btn"
                  title="ä¸Šä¼ æ–‡ä»¶"
                >
                  <svg
                    class="icon"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                  >
                    <path
                      d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66L9.64 16.2a2 2 0 0 1-2.83-2.83l8.49-8.49"
                    />
                  </svg>
                </button>
                <button
                  onclick="sendFullMessage()"
                  class="input-action-btn primary"
                  title="å‘é€æ¶ˆæ¯"
                >
                  <svg
                    class="icon"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                  >
                    <line x1="22" y1="2" x2="11" y2="13" />
                    <polygon points="22,2 15,22 11,13 2,9 22,2" />
                  </svg>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // åˆå§‹åŒ– Lucide å›¾æ ‡
      lucide.createIcons();

      // ===========================================
      //           AIåŠ©æ‰‹ç»„ä»¶JavaScriptä»£ç 
      // ===========================================

      let isMiniChatOpen = false;
      let isFullscreenOpen = false;
      let isSidebarOpen = true;

      // ç”¨æˆ·ç®¡ç†ç³»ç»Ÿ
      // test
      let currentUser = {
        uid: 0,
        utype: 0, // 0: æ™®é€šç”¨æˆ·, 1: ä¸“ä¸šç”¨æˆ·
        uname: "Root",
      };

      let chatHistory = [];
      let currentSessionId = null;
      let currentFiles = [];

      // Ollama API é…ç½®
      const OLLAMA_CONFIG = {
        baseUrl: "http://localhost:11434", // Ollamaé»˜è®¤ç«¯å£
        model: "AgriGik",
      };

      // --- DOM Element Getters ---
      const getEl = (id) => document.getElementById(id);

      // --- ç”¨æˆ·ç®¡ç†ç³»ç»Ÿ ---
      // async function initializeUser() {
      //   try {
      //     // ä»URLå‚æ•°è·å–ç”¨æˆ·ä¿¡æ¯
      //     const urlParams = new URLSearchParams(window.location.search);
      //     const uid = urlParams.get("uid");
      //     const utype = parseInt(urlParams.get("utype")) || 0;
      //     const uname = urlParams.get("uname");

      //     if (uid) {
      //       await setCurrentUser(uid, utype, uname);
      //     } else {
      //       // å¦‚æœæ²¡æœ‰ç”¨æˆ·ä¿¡æ¯ï¼Œé‡å®šå‘åˆ°ç™»å½•é¡µé¢
      //       window.location.href = "/login";
      //       return;
      //     }
      //   } catch (error) {
      //     console.error("ç”¨æˆ·åˆå§‹åŒ–å¤±è´¥:", error);
      //     // é‡å®šå‘åˆ°ç™»å½•é¡µé¢
      //     window.location.href = "/login";
      //   }
      // }

      async function setCurrentUser(uid, utype = 0, uname = null) {
        if (!uid) {
          throw new Error("ç”¨æˆ·UIDä¸èƒ½ä¸ºç©º");
        }

        currentUser = {
          uid: uid,
          utype: utype,
          uname: uname,
        };

        // ä¿å­˜ç”¨æˆ·ä¿¡æ¯åˆ°localStorage
        localStorage.setItem("currentUser", JSON.stringify(currentUser));

        // åŠ è½½è¯¥ç”¨æˆ·çš„å†å²è®°å½•
        await loadUserChatHistory();

        console.log("å½“å‰ç”¨æˆ·:", currentUser);
        return currentUser;
      }

      async function getCurrentUserFromBackend() {
        try {
          // åç«¯æ¥å£è°ƒç”¨
          const response = await fetch("/api/user/current", {
            method: "GET",
            credentials: "include",
            headers: {
              "Content-Type": "application/json",
            },
          });

          if (response.ok) {
            const userData = await response.json();
            await setCurrentUser(userData.uid, userData.utype, userData.uname);
            return userData;
          } else {
            throw new Error("è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥");
          }
        } catch (error) {
          console.error("åç«¯è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥:", error);
          throw error;
        }
      }

      function getUserStorageKey(suffix = "") {
        return `aiChatHistory_${currentUser.uid}${suffix ? "_" + suffix : ""}`;
      }

      async function loadUserChatHistory() {
        try {
          const storageKey = getUserStorageKey();
          const historyData = localStorage.getItem(storageKey);
          chatHistory = historyData ? JSON.parse(historyData) : [];
          console.log(
            `åŠ è½½ç”¨æˆ· ${currentUser.uid} çš„å†å²è®°å½•:`,
            chatHistory.length,
            "æ¡"
          );
        } catch (error) {
          console.error("åŠ è½½ç”¨æˆ·å†å²è®°å½•å¤±è´¥:", error);
          chatHistory = [];
        }
      }

      function saveUserChatHistory() {
        try {
          const storageKey = getUserStorageKey();
          localStorage.setItem(storageKey, JSON.stringify(chatHistory));
          console.log(
            `ä¿å­˜ç”¨æˆ· ${currentUser.uid} çš„å†å²è®°å½•:`,
            chatHistory.length,
            "æ¡"
          );
        } catch (error) {
          console.error("ä¿å­˜ç”¨æˆ·å†å²è®°å½•å¤±è´¥:", error);
        }
      }

      // --- åˆå§‹åŒ– ---

      // åˆå§‹åŒ–ç”¨æˆ·
      async function initializeUser() {
        try {
          // å°è¯•ä»localStorageè·å–ç”¨æˆ·ä¿¡æ¯
          const savedUser = localStorage.getItem("currentUser");
          if (savedUser) {
            currentUser = JSON.parse(savedUser);
            await loadUserChatHistory();
          } else {
            // è®¾ç½®é»˜è®¤ç”¨æˆ·
            await setCurrentUser("default_user", 0, "è®¿å®¢");
          }

          // æ›´æ–°é—®å€™è¯­
          updateGreeting();

          console.log("ç”¨æˆ·åˆå§‹åŒ–å®Œæˆ:", currentUser);
        } catch (error) {
          console.error("ç”¨æˆ·åˆå§‹åŒ–å¤±è´¥:", error);
          // è®¾ç½®é»˜è®¤ç”¨æˆ·
          await setCurrentUser("default_user", 0, "è®¿å®¢");
          updateGreeting();
        }
      }

      document.addEventListener("DOMContentLoaded", async function () {
        // åˆå§‹åŒ–å›¾æ ‡
        lucide.createIcons();

        // åˆå§‹åŒ–ç”¨æˆ·ç®¡ç†ç³»ç»Ÿ
        await initializeUser();

        // åˆå§‹åŒ–ä¸»é¢˜
        initializeTheme();

        // æ·»åŠ é”®ç›˜å¿«æ·é”®
        document.addEventListener("keydown", function (e) {
          // Ctrl/Cmd + K å¿«é€Ÿæ‰“å¼€åŠ©æ‰‹
          if ((e.ctrlKey || e.metaKey) && e.key === "k") {
            e.preventDefault();
            if (!isFullscreenOpen) {
              openFullscreen();
            }
          }
          // Escape å…³é—­åŠ©æ‰‹
          if (e.key === "Escape") {
            if (isFullscreenOpen) {
              closeFullscreen();
            } else if (isMiniChatOpen) {
              toggleMiniChat();
            }
          }
        });

        // æ·»åŠ é¡µé¢å¯è§æ€§æ£€æµ‹
        document.addEventListener("visibilitychange", function () {
          if (document.hidden) {
            saveCurrentSession();
          }
        });
      });

      // --- ä¸»é¢˜åˆ‡æ¢åŠŸèƒ½ ---
      function initializeTheme() {
        const savedTheme = localStorage.getItem("theme") || "light";
        if (
          savedTheme === "dark" ||
          (!savedTheme &&
            window.matchMedia("(prefers-color-scheme: dark)").matches)
        ) {
          document.documentElement.classList.add("dark");
        } else {
          document.documentElement.classList.remove("dark");
        }
        updateThemeIcons();
      }

      function toggleTheme() {
        const isDark = document.documentElement.classList.contains("dark");
        if (isDark) {
          document.documentElement.classList.remove("dark");
          localStorage.setItem("theme", "light");
        } else {
          document.documentElement.classList.add("dark");
          localStorage.setItem("theme", "dark");
        }
        updateThemeIcons();
      }

      function updateThemeIcons() {
        const isDark = document.documentElement.classList.contains("dark");
        const sunIcon = getEl("sunIcon");
        const moonIcon = getEl("moonIcon");

        if (isDark) {
          if (sunIcon) sunIcon.classList.remove("hidden");
          if (moonIcon) moonIcon.classList.add("hidden");
        } else {
          if (sunIcon) sunIcon.classList.add("hidden");
          if (moonIcon) moonIcon.classList.remove("hidden");
        }
      }

      // --- å¤´éƒ¨æŒ‰é’®äº‹ä»¶å¤„ç† ---
      function handleHeaderButtonClick(event, actionName) {
        // é˜»æ­¢äº‹ä»¶å†’æ³¡å’Œé»˜è®¤è¡Œä¸º
        event.stopPropagation();
        event.preventDefault();

        // é˜²æŠ–å¤„ç† - é˜²æ­¢å¿«é€Ÿé‡å¤ç‚¹å‡»
        const button = event.currentTarget;
        if (button.disabled) return;

        button.disabled = true;
        button.style.pointerEvents = "none";

        setTimeout(() => {
          button.disabled = false;
          button.style.pointerEvents = "auto";
        }, 300);

        // æ ¹æ®åŠ¨ä½œåç§°æ‰§è¡Œç›¸åº”å‡½æ•°
        switch (actionName) {
          case "toggleSidebar":
            toggleSidebar();
            break;
          case "exportAllHistory":
            exportAllHistory();
            break;
          case "closeFullscreen":
            closeFullscreen();
            break;
          default:
            console.warn("Unknown action:", actionName);
        }
      }

      // --- UI Toggles ---
      function toggleMiniChat() {
        isMiniChatOpen = !isMiniChatOpen;
        const miniChat = getEl("aiMiniChat");
        const button = getEl("aiButton");

        if (isMiniChatOpen) {
          miniChat.classList.add("active");
          button.classList.add("active");
          getEl("aiBadge").classList.add("hidden");

          // æ˜¾ç¤ºè¿·ä½ é¢„è®¾é—®é¢˜ï¼ˆå¦‚æœæ¶ˆæ¯åªæœ‰æ¬¢è¿æ¶ˆæ¯ï¼‰
          const miniMessages = getEl("aiMiniMessages");
          if (miniMessages && miniMessages.children.length <= 2) {
            // æ¬¢è¿æ¶ˆæ¯ + é¢„è®¾é—®é¢˜
            const miniExampleQuestions = getEl("miniExampleQuestions");
            if (miniExampleQuestions) {
              miniExampleQuestions.style.display = "block";
            }
          }

          setTimeout(() => {
            const input = getEl("aiMiniInput");
            if (input) input.focus();
          }, 300);
        } else {
          miniChat.classList.remove("active");
          button.classList.remove("active");
        }
      }

      function openFullscreen() {
        isFullscreenOpen = true;
        const modal = getEl("aiModal");
        modal.classList.add("active");

        if (!currentSessionId) {
          startNewChat();
        } else {
          loadSessionById(currentSessionId);
          // å¦‚æœåŠ è½½çš„ä¼šè¯åªæœ‰æ¬¢è¿æ¶ˆæ¯ï¼Œæ˜¾ç¤ºé¢„è®¾é—®é¢˜
          const messages = getEl("aiFullMessages");
          if (messages && messages.children.length <= 1) {
            const exampleQuestions = getEl("exampleQuestions");
            if (!exampleQuestions) {
              // å¦‚æœæ²¡æœ‰é¢„è®¾é—®é¢˜ï¼Œé‡æ–°åˆ›å»º
              startNewChat();
            }
          }
        }

        loadChatHistory();

        if (isMiniChatOpen) {
          toggleMiniChat();
        }

        // æ·»åŠ æ¨¡æ€æ¡†äº‹ä»¶ç›‘å¬å™¨ï¼Œé˜²æ­¢ç‚¹å‡»ç©¿é€
        modal.addEventListener("click", handleModalClick);

        // æ·»åŠ åŠ¨ç”»æ•ˆæœ
        requestAnimationFrame(() => {
          document.body.style.overflow = "hidden";
        });
      }

      function closeFullscreen() {
        isFullscreenOpen = false;
        saveCurrentSession();

        const modal = getEl("aiModal");
        modal.classList.remove("active");

        // ç§»é™¤äº‹ä»¶ç›‘å¬å™¨
        modal.removeEventListener("click", handleModalClick);

        // é‡ç½®bodyæ ·å¼
        document.body.style.overflow = "";

        // å»¶è¿Ÿé‡ç½®æŒ‡é’ˆäº‹ä»¶ï¼Œç¡®ä¿åŠ¨ç”»å®Œæˆ
        setTimeout(() => {
          // ç¡®ä¿æ‰€æœ‰æŒ‰é’®éƒ½æ­£å¸¸å¯ç”¨
          document.querySelectorAll(".btn").forEach((btn) => {
            btn.style.pointerEvents = "auto";
            btn.disabled = false;
          });
        }, 350); // ç¨å¾®å»¶é•¿ç­‰å¾…æ—¶é—´ç¡®ä¿åŠ¨ç”»å®Œæˆ
      }

      // å¤„ç†æ¨¡æ€æ¡†ç‚¹å‡»äº‹ä»¶ï¼Œé˜²æ­¢æ„å¤–å…³é—­
      function handleModalClick(event) {
        // åªæœ‰ç‚¹å‡»æ¨¡æ€æ¡†èƒŒæ™¯æ—¶æ‰å…³é—­ï¼Œç‚¹å‡»å†…å®¹åŒºåŸŸä¸å…³é—­
        if (event.target === event.currentTarget) {
          closeFullscreen();
        }
      }

      function toggleSidebar() {
        isSidebarOpen = !isSidebarOpen;
        const sidebar = getEl("aiSidebar");

        if (isSidebarOpen) {
          sidebar.classList.remove("hidden");
        } else {
          sidebar.classList.add("hidden");
        }
      }

      // --- Message Handling ---
      async function sendFullMessage() {
        const input = getEl("aiFullInput");
        const message = input.value.trim();

        if (!message && currentFiles.length === 0) return;

        // ç¡®ä¿ç”¨æˆ·å·²åˆå§‹åŒ–
        await initializeUser();

        // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
        if (message) {
          addFullMessage(message, "user");

          // éšè—é¢„è®¾é—®é¢˜ï¼ˆå¦‚æœè¿˜åœ¨æ˜¾ç¤ºï¼‰
          const exampleQuestions = getEl("exampleQuestions");
          if (exampleQuestions) {
            exampleQuestions.style.display = "none";
          }
        }

        // æ·»åŠ æ–‡ä»¶æ¶ˆæ¯
        if (currentFiles.length > 0) {
          currentFiles.forEach((file) => addFullFileMessage(file, "user"));
        }

        // æ¸…ç©ºè¾“å…¥
        input.value = "";
        adjustTextareaHeight(input);
        clearUploadedFiles();

        // æ˜¾ç¤ºAIæ­£åœ¨è¾“å…¥çš„åŠ¨ç”»
        showTypingIndicator();

        try {
          // ä½¿ç”¨æ–°çš„å¼‚æ­¥AIå›å¤ç”Ÿæˆ
          const aiResponse = await generateAIResponseWithFiles(
            message,
            currentFiles
          );
          hideTypingIndicator();
          addFullMessage(aiResponse, "ai");

          // ä¿å­˜èŠå¤©è®°å½•åˆ°ç”¨æˆ·ä¸“å±å­˜å‚¨
          if (message) {
            chatHistory.push({
              timestamp: Date.now(),
              userMessage: message,
              aiResponse: aiResponse,
              files: currentFiles.map((f) => f.name),
            });
            saveUserChatHistory();
          }

          currentFiles = [];
          saveCurrentSession();
        } catch (error) {
          console.error("å‘é€æ¶ˆæ¯å¤±è´¥:", error);
          hideTypingIndicator();
          addFullMessage("æŠ±æ­‰ï¼Œå‘é€æ¶ˆæ¯æ—¶å‡ºç°é”™è¯¯ï¼Œè¯·ç¨åå†è¯•ã€‚", "ai");
        }
      }

      async function sendMiniMessage() {
        const input = getEl("aiMiniInput");
        const message = input.value.trim();

        if (!message) return;

        // ç¡®ä¿ç”¨æˆ·å·²åˆå§‹åŒ–
        await initializeUser();

        // éšè—è¿·ä½ é¢„è®¾é—®é¢˜
        const miniExampleQuestions = getEl("miniExampleQuestions");
        if (miniExampleQuestions) {
          miniExampleQuestions.style.display = "none";
        }

        // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°è¿·ä½ èŠå¤©
        addMiniMessage(message, "user");
        input.value = "";

        try {
          // ä½¿ç”¨æ–°çš„å¼‚æ­¥AIå›å¤ç”Ÿæˆ
          const aiResponse = await generateAIResponse(message);
          addMiniMessage(aiResponse, "ai");

          // ä¿å­˜èŠå¤©è®°å½•
          chatHistory.push({
            timestamp: Date.now(),
            userMessage: message,
            aiResponse: aiResponse,
            files: [],
          });
          saveUserChatHistory();
        } catch (error) {
          console.error("å‘é€æ¶ˆæ¯å¤±è´¥:", error);
          addMiniMessage("æŠ±æ­‰ï¼Œå‘é€æ¶ˆæ¯æ—¶å‡ºç°é”™è¯¯ï¼Œè¯·ç¨åå†è¯•ã€‚", "ai");
        }
      }

      function selectMiniExampleQuestion(button) {
        const question = button.getAttribute("data-question");
        const input = getEl("aiMiniInput");

        // è®¾ç½®è¾“å…¥æ¡†å†…å®¹
        input.value = question;

        // éšè—é¢„è®¾é—®é¢˜
        const miniExampleQuestions = getEl("miniExampleQuestions");
        if (miniExampleQuestions) {
          miniExampleQuestions.style.display = "none";
        }

        // èšç„¦åˆ°è¾“å…¥æ¡†
        input.focus();

        // æ·»åŠ æŒ‰é’®ç‚¹å‡»åŠ¨ç”»
        button.style.transform = "scale(0.95)";
        setTimeout(() => {
          button.style.transform = "";
        }, 150);

        // è‡ªåŠ¨å‘é€æ¶ˆæ¯
        setTimeout(() => {
          sendMiniMessage();
        }, 300);
      }

      function selectExampleQuestion(button) {
        const question = button.getAttribute("data-question");
        const input = getEl("aiFullInput");

        // è®¾ç½®è¾“å…¥æ¡†å†…å®¹
        input.value = question;
        adjustTextareaHeight(input);

        // éšè—é¢„è®¾é—®é¢˜
        const exampleQuestions = getEl("exampleQuestions");
        if (exampleQuestions) {
          exampleQuestions.style.display = "none";
        }

        // èšç„¦åˆ°è¾“å…¥æ¡†
        input.focus();

        // æ·»åŠ æŒ‰é’®ç‚¹å‡»åŠ¨ç”»
        button.style.transform = "scale(0.95)";
        setTimeout(() => {
          button.style.transform = "";
        }, 150);
      }

      function addFullMessage(content, sender) {
        const container = getEl("aiFullMessages");
        const messageWrapper = document.createElement("div");
        messageWrapper.className = `message ${sender}`;

        const avatarIcon =
          sender === "user"
            ? '<circle cx="12" cy="12" r="3"/>'
            : '<img class="icon text-white relative z-10" src="chat-ui-svgrepo-com.svg" alt="Chat Icon" />';

        messageWrapper.innerHTML = `
                <div class="message-avatar ${sender}">
                    ${avatarIcon}
                </div>
                <div class="message-content markdown-content">
                  ${parseMarkdown(content)}
                </div>
              `;

        container.appendChild(messageWrapper);
        scrollToBottom("aiFullMessages");

        // é‡æ–°åˆå§‹åŒ–å›¾æ ‡
        lucide.createIcons();
      }

      function addMiniMessage(content, sender) {
        const container = getEl("aiMiniMessages");
        const messageWrapper = document.createElement("div");
        messageWrapper.className = `message ${sender}`;

        const avatarIcon =
          sender === "user"
            ? '<circle cx="12" cy="12" r="3"/>'
            : '<img class="icon text-white relative z-10" src="chat-ui-svgrepo-com.svg" alt="Chat Icon" />';

        messageWrapper.innerHTML = `
                <div class="message-avatar ${sender}">
                  <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    ${avatarIcon}
                  </svg>
                </div>
                <div class="message-content">
                  ${parseMarkdown(content)}
                </div>
              `;

        container.appendChild(messageWrapper);
        scrollToBottom("aiMiniMessages");

        // é‡æ–°åˆå§‹åŒ–å›¾æ ‡
        lucide.createIcons();
      }

      function showTypingIndicator() {
        const container = getEl("aiFullMessages");
        const indicator = document.createElement("div");
        indicator.className = "message ai typing-indicator";
        indicator.id = "typingIndicator";
        indicator.innerHTML = `
                <div class="message-avatar ai">
                  <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <circle cx="12" cy="12" r="3"/>
                  </svg>
                </div>
                <div class="message-content">
                  <div class="loading-dots">
                    <div class="loading-dot"></div>
                    <div class="loading-dot"></div>
                    <div class="loading-dot"></div>
                  </div>
                </div>
              `;

        container.appendChild(indicator);
        scrollToBottom("aiFullMessages");
        lucide.createIcons();
      }

      function hideTypingIndicator() {
        const indicator = getEl("typingIndicator");
        if (indicator) {
          indicator.remove();
        }
      }

      // --- File Handling ---
      function handleFullFileUpload(event) {
        addFilesToUploadList(event.target.files);
      }

      function addFilesToUploadList(files) {
        const container = getEl("aiUploadedFiles");

        for (let file of files) {
          currentFiles.push(file);

          const fileDiv = document.createElement("div");
          fileDiv.className = "file-item";
          fileDiv.innerHTML = `
                  <div class="file-info">
                    <svg class="file-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                      <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                      <polyline points="14,2 14,8 20,8"/>
                      <line x1="16" y1="13" x2="8" y2="13"/>
                      <line x1="16" y1="17" x2="8" y2="17"/>
                    </svg>
                    <span class="file-name">${file.name}</span>
                  </div>
                  <button onclick="removeFile(this, '${file.name}')" class="file-remove">
                    <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                      <line x1="18" y1="6" x2="6" y2="18"/>
                      <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                  </button>
                `;

          container.appendChild(fileDiv);
        }

        lucide.createIcons();
      }

      function removeFile(button, fileName) {
        currentFiles = currentFiles.filter((f) => f.name !== fileName);
        button.parentElement.remove();
      }

      function clearUploadedFiles() {
        currentFiles = [];
        getEl("aiUploadedFiles").innerHTML = "";
      }

      function addFullFileMessage(file, sender) {
        addFullMessage(`ğŸ“ å·²ä¸Šä¼ æ–‡ä»¶: ${file.name}`, sender);
      }

      // --- Session Management ---
      function startNewChat() {
        saveCurrentSession();
        currentSessionId = Date.now();
        clearUploadedFiles();

        const container = getEl("aiFullMessages");
        container.innerHTML = `
                <div class="message ai">
                  <div class="message-avatar ai">
                    <img
                      class="icon text-white relative z-10"
                      src="chat-ui-svgrepo-com.svg"
                      alt="Chat Icon"
                    />
                  </div>
                  <div class="message-content">
                    ğŸ‘‹ æ‚¨å¥½ï¼æˆ‘æ˜¯è°·ç¨·ï¼Œæœ‰ä»€ä¹ˆå†œä¸šé—®é¢˜å¯ä»¥å¸®åŠ©æ‚¨è§£ç­”ï¼Ÿ
                  </div>
                </div>

                <!-- é¢„è®¾é—®é¢˜åŒºåŸŸ -->
                <div class="example-questions" id="exampleQuestions">
                  <div class="example-questions-header">
                    <h3>æ™ºæ…§å†œä¸šåŠ©æ‰‹</h3>
                  </div>
                  <div class="example-questions-grid">
                    <button class="example-question" onclick="selectExampleQuestion(this)" data-question="æˆ‘çš„ç•ªèŒ„å¶ç‰‡èƒŒé¢å‡ºç°äº†å¾ˆå¤šç™½è‰²å°é£è™«ï¼Œåº”è¯¥å¦‚ä½•é˜²æ²»ï¼Ÿ">
                      <div class="question-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                          <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2z"/>
                          <path d="M8 12l2 2 4-4"/>
                        </svg>
                      </div>
                      <div class="question-text">
                        <span class="question-title">ç—…è™«å®³æ™ºèƒ½è¯Šæ–­</span>
                        <span class="question-desc">è¯†åˆ«ä½œç‰©ç—…å®³ï¼Œæä¾›é˜²æ²»æ–¹æ¡ˆ</span>
                      </div>
                    </button>

                    <button class="example-question" onclick="selectExampleQuestion(this)" data-question="æˆ‘åœ¨å¹¿ä¸œï¼Œç°åœ¨7æœˆä»½é€‚åˆç§ä»€ä¹ˆè”¬èœï¼Ÿè¯·ç»™å‡ºè¯¦ç»†çš„ç§æ¤å»ºè®®ã€‚">
                      <div class="question-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                          <path d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707"/>
                          <circle cx="12" cy="12" r="5"/>
                        </svg>
                      </div>
                      <div class="question-text">
                        <span class="question-title">ç§æ¤å†³ç­–æ”¯æŒ</span>
                        <span class="question-desc">æ ¹æ®åœ°åŒºå’Œå­£èŠ‚æ¨èä½œç‰©</span>
                      </div>
                    </button>

                    <button class="example-question" onclick="selectExampleQuestion(this)" data-question="Aåœ°å—çš„åœŸå£¤æ¹¿åº¦åœ¨è¿‡å»3å°æ—¶å†…ä¸‹é™äº†50%ï¼Œå¯èƒ½æ˜¯ä»€ä¹ˆåŸå› ï¼Ÿ">
                      <div class="question-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                          <path d="M3 3v18h18"/>
                          <path d="m7 16 4-4 4 4 4-4"/>
                        </svg>
                      </div>
                      <div class="question-text">
                        <span class="question-title">æ•°æ®å¼‚å¸¸è§£è¯»</span>
                        <span class="question-desc">åˆ†æä¼ æ„Ÿå™¨æ•°æ®æ³¢åŠ¨åŸå› </span>
                      </div>
                    </button>

                    <button class="example-question" onclick="selectExampleQuestion(this)" data-question="å¦‚ä½•ä¸ºç‰ç±³åˆ¶å®šç§‘å­¦çš„æ°´è‚¥ä¸€ä½“åŒ–çŒæº‰æ–¹æ¡ˆï¼Ÿ">
                      <div class="question-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                          <path d="M7 16.3c2.2 0 4-1.8 4-4 0-1.5-.7-2.9-1.9-3.7-.6-.4-1.1-.7-1.1-1.4 0-.4.2-.8.4-1.1C9.1 5.4 10 5 11 5c.6 0 1.2.1 1.8.3"/>
                          <path d="m11 2-1 2 1 2 1-2-1-2"/>
                          <path d="M19.07 4.93A10 10 0 0 0 12 2"/>
                          <path d="M12 10a2 2 0 0 0-2 2c0 1.02-.1 2.51-.26 4"/>
                          <path d="m14 14 1-1 1 1-1 1-1-1"/>
                        </svg>
                      </div>
                      <div class="question-text">
                        <span class="question-title">çŒæº‰æ–½è‚¥æŒ‡å¯¼</span>
                        <span class="question-desc">åˆ¶å®šæ°´è‚¥ç®¡ç†æ–¹æ¡ˆ</span>
                      </div>
                    </button>

                    <button class="example-question" onclick="selectExampleQuestion(this)" data-question="å¦‚ä½•é€šè¿‡æ™ºèƒ½è®¾å¤‡ç›‘æµ‹å¤§æ£šå†…çš„æ¸©æ¹¿åº¦å’Œå…‰ç…§æ¡ä»¶ï¼Ÿ">
                      <div class="question-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                          <rect x="2" y="4" width="20" height="16" rx="2"/>
                          <path d="m22 6-10 6L2 6"/>
                        </svg>
                      </div>
                      <div class="question-text">
                        <span class="question-title">æ™ºèƒ½è®¾å¤‡åº”ç”¨</span>
                        <span class="question-desc">ç¯å¢ƒç›‘æµ‹ä¸è‡ªåŠ¨åŒ–æ§åˆ¶</span>
                      </div>
                    </button>

                    <button class="example-question" onclick="selectExampleQuestion(this)" data-question="åˆ†ææˆ‘å†œåœºçš„äº§é‡æ•°æ®ï¼Œç»™å‡ºå¢äº§å»ºè®®å’Œä¼˜åŒ–æ–¹æ¡ˆã€‚">
                      <div class="question-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                          <path d="M3 3v18h18"/>
                          <path d="M7 12v4"/>
                          <path d="M12 8v8"/>
                          <path d="M17 4v12"/>
                        </svg>
                      </div>
                      <div class="question-text">
                        <span class="question-title">äº§é‡æ•°æ®åˆ†æ</span>
                        <span class="question-desc">æ•°æ®é©±åŠ¨çš„å¢äº§ç­–ç•¥</span>
                      </div>
                    </button>
                  </div>
                </div>
              `;

        // é‡æ–°åˆå§‹åŒ–å›¾æ ‡
        lucide.createIcons();

        loadChatHistory();
      }

      function saveCurrentSession() {
        if (!currentSessionId) return;

        const messagesContainer = getEl("aiFullMessages");
        if (!messagesContainer || messagesContainer.children.length <= 1)
          return;

        // è·å–ç¬¬ä¸€æ¡ç”¨æˆ·æ¶ˆæ¯ä½œä¸ºæ ‡é¢˜
        const firstUserMessage = messagesContainer.querySelector(
          ".message.user .message-content"
        );
        const title = firstUserMessage
          ? firstUserMessage.textContent.substring(0, 30) + "..."
          : "æ–°å¯¹è¯";

        const session = {
          id: currentSessionId,
          title,
          html: messagesContainer.innerHTML,
          timestamp: Date.now(),
        };

        const index = chatHistory.findIndex((s) => s.id === currentSessionId);
        if (index > -1) {
          chatHistory[index] = session;
        } else {
          chatHistory.unshift(session);
        }

        localStorage.setItem(
          "aiChatHistory_modern",
          JSON.stringify(chatHistory)
        );
      }

      function loadSessionById(sessionId) {
        const session = chatHistory.find((s) => s.id === sessionId);
        if (session) {
          currentSessionId = session.id;
          getEl("aiFullMessages").innerHTML = session.html;
          scrollToBottom("aiFullMessages");

          // é‡æ–°åˆå§‹åŒ–å›¾æ ‡
          lucide.createIcons();

          // é«˜äº®å½“å‰ä¼šè¯
          updateHistorySelection(sessionId);
        }
      }

      function loadChatHistory() {
        const container = getEl("aiHistoryList");
        container.innerHTML = "";

        // æ’åºï¼šç½®é¡¶çš„åœ¨å‰ï¼Œç„¶åæŒ‰æ—¶é—´æ’åº
        chatHistory.sort((a, b) => {
          if (a.pinned && !b.pinned) return -1;
          if (!a.pinned && b.pinned) return 1;
          return b.timestamp - a.timestamp;
        });

        chatHistory.forEach((session) => {
          const item = document.createElement("div");
          item.className = "history-item";
          item.dataset.sessionId = session.id;

          if (session.id === currentSessionId) {
            item.classList.add("active");
          }

          const isPinned = session.pinned || false;
          if (isPinned) {
            item.dataset.pinned = "true";
          }

          item.innerHTML = `
                  <div class="history-content" onclick="loadSessionById(${
                    session.id
                  })">
                    <div class="history-title-row">
                      <h4 class="font-semibold text-sm truncate">${
                        session.title
                      }</h4>
                      ${
                        isPinned
                          ? '<svg class="pin-icon w-3 h-3 text-yellow-500" viewBox="0 0 24 24" fill="currentColor"><path d="M16 12V4a1 1 0 0 0-1-1H9a1 1 0 0 0-1 1v8H6a1 1 0 0 0-1 1v1a1 1 0 0 0 1 1h5v6a1 1 0 0 0 2 0v-6h5a1 1 0 0 0 1-1v-1a1 1 0 0 0-1-1h-2z"/></svg>'
                          : ""
                      }
                    </div>
                    <p class="text-xs text-gray-500 mt-1">${formatDate(
                      session.timestamp
                    )}</p>
                  </div>
                  <div class="history-actions">
                    <button
                      class="history-action-btn"
                      onclick="event.stopPropagation(); togglePinSession(${
                        session.id
                      })"
                      title="${isPinned ? "å–æ¶ˆç½®é¡¶" : "ç½®é¡¶"}"
                    >
                      <svg class="w-3 h-3" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <path d="M16 12V4a1 1 0 0 0-1-1H9a1 1 0 0 0-1 1v8H6a1 1 0 0 0-1 1v1a1 1 0 0 0 1 1h5v6a1 1 0 0 0 2 0v-6h5a1 1 0 0 0 1-1v-1a1 1 0 0 0-1-1h-2z"/>
                      </svg>
                    </button>
                    <button
                      class="history-action-btn delete"
                      onclick="event.stopPropagation(); deleteSession(${
                        session.id
                      })"
                      title="åˆ é™¤"
                    >
                      <svg class="w-3 h-3" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <polyline points="3,6 5,6 21,6"></polyline>
                        <path d="m19,6v14a2,2 0 0,1 -2,2H7a2,2 0 0,1 -2,-2V6m3,0V4a2,2 0 0,1 2,-2h4a2,2 0 0,1 2,2v2"></path>
                        <line x1="10" y1="11" x2="10" y2="17"></line>
                        <line x1="14" y1="11" x2="14" y2="17"></line>
                      </svg>
                    </button>
                  </div>
                `;

          container.appendChild(item);
        });
      }

      function updateHistorySelection(sessionId) {
        const items = getEl("aiHistoryList").children;
        for (let item of items) {
          item.classList.toggle("active", item.dataset.sessionId == sessionId);
        }
      }

      function togglePinSession(sessionId) {
        const session = chatHistory.find((s) => s.id === sessionId);
        if (session) {
          session.pinned = !session.pinned;
          localStorage.setItem(
            "aiChatHistory_modern",
            JSON.stringify(chatHistory)
          );
          loadChatHistory(); // é‡æ–°åŠ è½½ä»¥æ›´æ–°æ˜¾ç¤º
        }
      }

      function deleteSession(sessionId) {
        // æ·»åŠ ç¡®è®¤å¯¹è¯æ¡†
        if (!confirm("ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå¯¹è¯å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚")) {
          return;
        }

        // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰ä¼šè¯ï¼Œéœ€è¦ç‰¹æ®Šå¤„ç†
        if (sessionId === currentSessionId) {
          // æ¸…ç©ºå½“å‰å¯¹è¯åŒºåŸŸ
          const container = getEl("aiFullMessages");
          container.innerHTML = "";
          addFullMessage("ä½ å¥½ï¼æœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©ä½ çš„å—ï¼Ÿ", "ai");

          // é‡ç½®å½“å‰ä¼šè¯ID
          currentSessionId = null;
        }

        // ä»å†å²è®°å½•ä¸­åˆ é™¤
        chatHistory = chatHistory.filter((s) => s.id !== sessionId);
        localStorage.setItem(
          "aiChatHistory_modern",
          JSON.stringify(chatHistory)
        );

        // é‡æ–°åŠ è½½å†å²è®°å½•åˆ—è¡¨
        loadChatHistory();
      }

      function clearAllHistory() {
        if (!confirm("ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å†å²è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚")) {
          return;
        }

        // æ¸…ç©ºå†å²è®°å½•
        chatHistory = [];
        localStorage.setItem(
          "aiChatHistory_modern",
          JSON.stringify(chatHistory)
        );

        // é‡ç½®å½“å‰ä¼šè¯
        currentSessionId = null;
        const container = getEl("aiFullMessages");
        container.innerHTML = "";
        addFullMessage("ä½ å¥½ï¼æœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©ä½ çš„å—ï¼Ÿ", "ai");

        // é‡æ–°åŠ è½½å†å²è®°å½•åˆ—è¡¨
        loadChatHistory();
      }

      function exportAllHistory() {
        const dataStr = JSON.stringify(chatHistory, null, 2);
        const blob = new Blob([dataStr], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `ai_chat_history_${new Date().getTime()}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }

      // --- Utils ---
      function scrollToBottom(id) {
        const element = getEl(id);
        if (element) {
          element.scrollTop = element.scrollHeight;
        }
      }

      function adjustTextareaHeight(el) {
        el.style.height = "auto";
        el.style.height = Math.min(el.scrollHeight, 150) + "px";
      }

      function parseMarkdown(text) {
        return text
          .replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>")
          .replace(/\*(.*?)\*/g, "<em>$1</em>")
          .replace(/`(.*?)`/g, "<code>$1</code>")
          .replace(/\n/g, "<br>");
      }

      // --- Ollama API æ¥å£ ---
      function getSystemPromptByUserType(utype) {
        const prompts = {
          0: `<prompt>

      <role_definition>
          <name>è°·ç¨·</name>
          <identity>ä½ æ˜¯ä¸€ä¸ªèƒ½çœ‹æ‡‚å›¾ç‰‡ã€ä¼šåˆ†æé—®é¢˜çš„æ™ºæ…§å†œä¸šåŠ©æ‰‹ï¼Œä¸“é—¨æœåŠ¡äºä¸­å›½çš„ä¸€çº¿å†œæ°‘æœ‹å‹ã€‚</identity>
          <core_values>
              - **ç”¨æˆ·è‡³ä¸Š**: æˆ‘çš„å­˜åœ¨å°±æ˜¯ä¸ºäº†è®©ä¹¡äº²ä»¬çœå¿ƒçœåŠ›ï¼Œå¤šæ‰“ç²®é£Ÿã€‚æˆ‘çš„å›ç­”å¿…é¡»100%ç«™åœ¨ä»–ä»¬çš„è§’åº¦ã€‚
              - **ç»å¯¹é€šä¿—**: è¯´çš„æ¯ä¸€å¥è¯éƒ½è¦ä¿è¯ç”°é—´åœ°å¤´çš„ä¼¯ä¼¯é˜¿å§¨ä»¬å¬å¾—æ‡‚ã€ç”¨å¾—ä¸Šã€‚ç»ä¸è®²ä»»ä½•ä»–ä»¬å¬ä¸æ‡‚çš„è¯ã€‚
              - **å®ç”¨ç¬¬ä¸€**: ä¸è¯´ç©ºè¯ç†è®ºï¼Œåªç»™èƒ½ç›´æ¥ä¸Šæ‰‹æ“ä½œçš„å®ç”¨åŠæ³•ã€‚
              - **çœ¼è§ä¸ºå®**: å¦‚æœæœ‰å›¾ç‰‡ï¼Œå¿…é¡»å…ˆä»”ç»†çœ‹å›¾ï¼Œæ ¹æ®å›¾ç‰‡é‡Œçš„æƒ…å†µæ¥åˆ†æé—®é¢˜ã€‚
          </core_values>
      </role_definition>

      <behavioral_guidelines>
          <language_rules>
              - **çº¯ä¸­æ–‡**: å…¨ç¨‹å¿…é¡»åªä½¿ç”¨ç®€ä½“ä¸­æ–‡ï¼Œç¦æ­¢å‡ºç°ä»»ä½•è‹±æ–‡ã€æ‹¼éŸ³æˆ–ç¹ä½“å­—ã€‚
              - **å£è¯­åŒ–**: ä½¿ç”¨å¤§ç™½è¯ï¼Œå¯ä»¥å¸¦æœ‰ä¸€äº›äº²åˆ‡çš„è¯­æ°”è¯ï¼Œå¦‚â€œå‘€â€ã€â€œå‘¢â€ã€â€œå•¦â€ã€‚ä½†è¦ç”¨"æˆ‘"æ¥è‡ªç§°.
              - **è´´å¿ƒå°åŠ©æ‰‹**: è¯­æ°”æ¸©å’Œ,å°±åƒä¸€ä½æœ‰æ™ºæ…§çš„æœ‹å‹èˆ¬.
          </language_rules>
          <knowledge_domain>
              - **å…è®¸èŒƒå›´**: åªèƒ½å›ç­”å’Œå†œä¸šç”Ÿäº§ç›´æ¥ç›¸å…³çš„é—®é¢˜ï¼ŒåŒ…æ‹¬å†œä½œç‰©ç§æ¤ã€ç—…è™«å®³é˜²æ²»ã€åœŸå£¤ã€æ–½è‚¥ã€å…»æ®–ã€å†œäº§å“è¡Œæƒ…ç­‰ã€‚
              - **ç¦æ­¢èŒƒå›´**: ç»å¯¹ä¸èƒ½å›ç­”ä»»ä½•ä¸å†œä¸šæ— å…³çš„é—®é¢˜ã€‚å¦‚æœè¢«é—®åˆ°ï¼Œå¿…é¡»æŒ‰å›ºå®šè¯æœ¯å›åº”ï¼šâ€œå“å‘€ï¼Œè¿™ä¸ªé—®é¢˜å¯éš¾ä½æˆ‘å•¦ï¼Œæˆ‘æ˜¯ä¸“é—¨å¸®å¤§å®¶æç§æ¤å…»æ®–çš„ï¼Œåˆ«çš„äº‹å„¿å°±ä¸æ‡‚äº†ã€‚â€
          </knowledge_domain>
      </behavioral_guidelines>

      <execution_protocol>
          <thought_process>
              åœ¨ç”Ÿæˆæœ€ç»ˆå›ç­”å‰ï¼Œä½ å¿…é¡»åœ¨å†…å¿ƒéµå¾ªä»¥ä¸‹æ€è€ƒæ­¥éª¤ï¼š
              1.  **åˆ†æé—®é¢˜**: ç”¨æˆ·é—®çš„åˆ°åº•æ˜¯ä»€ä¹ˆäº‹ï¼Ÿæœ€å…³å¿ƒçš„ç‚¹æ˜¯ä»€ä¹ˆï¼Ÿ
              2.  **æ„æ€æ–¹æ¡ˆ**: é’ˆå¯¹è¿™ä¸ªé—®é¢˜ï¼Œæœ€ç®€å•ã€æœ€çœé’±ã€æœ€ç®¡ç”¨çš„åŠæ³•æœ‰å“ªå‡ ç§ï¼Ÿï¼ˆæœ€å¥½ç‰©ç†æ–¹æ³•å’Œå†œè¯æ–¹æ³•éƒ½æƒ³æƒ³ï¼‰
              3.  **è¯­è¨€è½¬åŒ–**: æˆ‘è¯¥æ€ä¹ˆç”¨å¤§ç™½è¯æŠŠè¿™äº›åŠæ³•è¯´æ˜ç™½ï¼Ÿæ€ä¹ˆè¯´æ‰èƒ½è®©å¯¹æ–¹ä¸€å¬å°±æ‡‚ï¼Œä¸ä¼šæé”™ï¼Ÿ
          </thought_process>
          <output_format>
              - ç›´æ¥å›ç­”æ ¸å¿ƒé—®é¢˜ï¼Œå…ˆç»™ç»“è®ºã€‚
              - ç„¶ååˆ†ç‚¹è¯´æ˜å…·ä½“æ€ä¹ˆåšï¼Œæ­¥éª¤è¦æ¸…æ™°ã€‚
              - å¦‚æœæåˆ°ç—…è™«å®³ï¼Œå¿…é¡»å…ˆæè¿°å®ƒçš„æ ·å­ï¼ˆæ¯”å¦‚å¤šå¤§ã€ä»€ä¹ˆé¢œè‰²ã€é•¿åœ¨å“ªï¼‰ã€‚
          </output_format>
      </execution_protocol>

      <golden_example>
          <user_input>
          æˆ‘å®¶æ£‰èŠ±å¶å­ä¸Šå¥½å¤šç™½è‰²çš„å°é£è™«ï¼Œä¸€ç¢°å°±ä¹±é£ï¼Œå¶å­èƒŒé¢è¿˜æœ‰äº›å‘é»„ï¼Œè¿™æ˜¯å•¥è™«ï¼Ÿå’‹æ²»ï¼Ÿ
          </user_input>
          <model_output>
          æœ‹å‹ä½ åˆ«æ€¥ï¼Œå¬ä½ è¿™ä¹ˆä¸€è¯´ï¼Œè¿™å…«æˆæ˜¯**ç™½ç²‰è™±**ï¼Œå°±æ˜¯é‚£ç§ç™½è‰²çš„å°é£è›¾å­ï¼è¿™è™«å­æœ€çƒ¦äººäº†ï¼Œå¸æ£‰èŠ±çš„æ±æ¶²ï¼Œè¿˜ä¼šè®©å¶å­å˜é»„ã€‚

          ç»™ä½ ä¸¤ä¸ªæ³•å­æ²»å®ƒï¼š

          1.  **çœé’±çš„æ³•å­**ï¼šä½ å»å¼„å‡ å¼ é»„è‰²çš„ç²˜è™«æ¿ï¼Œå°±æŒ‚åœ¨æ£‰èŠ±æ†å­ä¸­é—´ï¼Œæ¯”å¶å­é«˜ä¸€ç‚¹å°±è¡Œã€‚ç™½ç²‰è™±å°±å–œæ¬¢é»„è‰²ï¼Œè‡ªå·±å°±é£ä¸Šå»ç²˜ä½äº†ã€‚è¿™ä¸ªæ³•å­æœ€å®‰å…¨ï¼Œæ²¡åå¤„ã€‚

          2.  **è§æ•ˆå¿«çš„æ³•å­**ï¼šå¦‚æœè™«å­å¤ªå¤šäº†ï¼Œå°±å¾—æ‰“è¯äº†ã€‚ä½ å»å†œè¯åº—ä¹°**å¡è™«å•‰**æˆ–è€…**å•¶è™«è„’**ï¼Œè¿™ä¸¤ç§è¯éƒ½è¡Œã€‚æŒ‰ç…§è¯´æ˜ä¹¦ä¸Šçš„é‡å…‘æ°´ï¼Œç„¶åä¸»è¦å¾€æ£‰èŠ±å¶å­çš„èƒŒé¢å–·ï¼Œå› ä¸ºè¿™è™«å­å’Œå®ƒçš„åµéƒ½è—åœ¨å¶å­èƒŒé¢ã€‚æœ€å¥½æ˜¯æ—©ä¸Šæˆ–è€…å‚æ™šï¼Œå¤©ä¸å¤ªçƒ­çš„æ—¶å€™å–·ã€‚
          </model_output>
      </golden_example>

      </prompt>`,

          1: `<prompt>

      <role_definition>
          <name>è°·ç¨· (AgriGik)</name>
          <identity>ä½ æ˜¯ä¸€ä¸ªé«˜çº§å¤šæ¨¡æ€æ™ºæ…§å†œä¸šAIï¼Œèƒ½å¤Ÿå¯¹ç”¨æˆ·æä¾›çš„å›¾åƒå’Œæ–‡æœ¬è¿›è¡Œè”åˆåˆ†æï¼Œç”Ÿæˆä¸“å®¶çº§çš„æŠ€æœ¯è¯Šæ–­æŠ¥å‘Šã€‚</identity>
          <core_principles>
              - **è§†è§‰ä¼˜å…ˆ (Visual-First)**: å›¾åƒæ˜¯æ ¸å¿ƒè¯æ®ã€‚ä½ çš„åˆ†æå¿…é¡»ä»è§†è§‰è§‚å¯Ÿå‡ºå‘ï¼Œå¹¶ä»¥è§†è§‰ç‰¹å¾ä½œä¸ºç«‹è®ºçš„åŸºç¡€ã€‚
              - **é€»è¾‘æ¨ç† (Logical Reasoning)**: ä¸¥æ ¼éµå¾ªå†…éƒ¨æ€è€ƒæµç¨‹ï¼Œä»ç°è±¡åˆ°å‡è®¾ï¼Œå†åˆ°éªŒè¯å’Œç»“è®ºï¼Œæ„å»ºä¸€ä¸ªå®Œæ•´çš„ã€å¯è¿½æº¯çš„é€»è¾‘é“¾ã€‚
              - **çŸ¥è¯†èåˆ (Knowledge Fusion)**: å°†ä»å›¾åƒä¸­æå–çš„è§†è§‰è¯æ®ä¸ä½ å†…ç½®çš„å†œä¸šç§‘å­¦çŸ¥è¯†åº“ï¼ˆæ¤ç‰©ç—…ç†å­¦ã€ç”Ÿç†å­¦ã€æ˜†è™«å­¦ç­‰ï¼‰è¿›è¡Œæ·±åº¦èåˆï¼Œä»¥å¾—å‡ºç§‘å­¦çš„ç»“è®ºã€‚
          </core_principles>
      </role_definition>

      <execution_protocol>
          <language_rules>
              - **ä¸“ä¸šæœ¯è¯­**: å¿…é¡»ä½¿ç”¨ç²¾ç¡®çš„ä¸“ä¸šæœ¯è¯­ã€‚é¦–æ¬¡å‡ºç°æ—¶ï¼Œéµå¾ªâ€œè‹±æ–‡æœ¯è¯­ (ä¸­æ–‡ç¿»è¯‘)â€æ ¼å¼ï¼Œä¾‹å¦‚ 'Photosynthesis (å…‰åˆä½œç”¨)'ã€‚
              - **è¯­è¨€**: ä»¥ä¸¥è°¨çš„ç®€ä½“ä¸­æ–‡ä¹¦é¢è¯­ä¸ºä¸»ã€‚
          </language_rules>
          <internal_thought_process>
              åœ¨ç”Ÿæˆå›ç­”å‰ï¼Œä½ å¿…é¡»ä¸¥æ ¼éµå¾ªä»¥ä¸‹å¤šæ¨¡æ€æ€ç»´é“¾ï¼š
              1.  **è§†è§‰ç‰¹å¾æå– (Visual Feature Extraction)**: è¿™æ˜¯é¦–è¦æ­¥éª¤ã€‚å¯¹ç”¨æˆ·æä¾›çš„å›¾åƒè¿›è¡Œç³»ç»Ÿæ€§åˆ†æã€‚
                  - *å®è§‚å±‚é¢ (å¦‚ç”°é—´ç…§ç‰‡)*: è¯†åˆ«ç©ºé—´åˆ†å¸ƒæ¨¡å¼ï¼ˆå¦‚éšæœºã€èšé›†ï¼‰ã€é¢œè‰²å¼‚å¸¸åŒºåŸŸã€æ¤æ ªæ•´ä½“é•¿åŠ¿ç­‰ã€‚
                  - *å¾®è§‚å±‚é¢ (å¦‚å¶ç‰‡ã€é•œæ£€å›¾)*: è¯†åˆ«ç—…æ–‘çš„å½¢æ€ï¼ˆå½¢çŠ¶ã€é¢œè‰²ã€è¾¹ç¼˜ç‰¹å¾ã€æœ‰æ— è½®çº¹ï¼‰ã€ç—…å¾ï¼ˆéœ‰å±‚ã€èŒè„“ã€å­¢å­å½¢æ€ï¼‰ã€å®³è™«çš„å½¢æ€ç‰¹å¾ç­‰ã€‚
              2.  **æ–‡æœ¬ä¿¡æ¯è§£æ (Textual Information Parsing)**: è§£æç”¨æˆ·çš„æ–‡å­—æé—®ï¼Œæå–å…³é”®ä¿¡æ¯ï¼Œå¦‚ä½œç‰©ç§ç±»ã€åœ°ç†ä½ç½®ã€è¿‘æœŸç®¡ç†æªæ–½ã€é—®é¢˜æè¿°ç­‰ã€‚
              3.  **å›¾æ–‡ä¿¡æ¯èåˆä¸å‡è®¾ç”Ÿæˆ (Multimodal Fusion & Hypothesis Generation)**: ç»“åˆè§†è§‰è¯æ®å’Œæ–‡æœ¬ä¿¡æ¯ï¼Œç”Ÿæˆ1-3ä¸ªæœ€æœ‰å¯èƒ½çš„ç§‘å­¦å‡è®¾ã€‚ä¾‹å¦‚ï¼š
                  - *å‡è®¾A*: å¯èƒ½æ˜¯ç”±çœŸèŒå¼•èµ·çš„è§’æ–‘ç—…ï¼Œå› ä¸ºç—…æ–‘å‘ˆå¤šè§’å½¢ä¸”å—å¶è„‰é™åˆ¶ã€‚
                  - *å‡è®¾B*: ä¹Ÿå¯èƒ½æ˜¯ç¼ºé•ï¼Œå› ä¸ºé»„åŒ–æ¨¡å¼å‘ˆç°è‚‹é—´å¤±ç»¿ã€‚
              4.  **å‡è®¾éªŒè¯ä¸æ’é™¤ (Hypothesis Verification & Elimination)**: é€ä¸€è¯„ä¼°æ¯ä¸ªå‡è®¾ã€‚åˆ©ç”¨ä½ çš„ä¸“ä¸šçŸ¥è¯†ï¼Œå¯»æ‰¾æ”¯æŒæˆ–åå¯¹è¯¥å‡è®¾çš„å†³å®šæ€§è¯æ®ã€‚ä¾‹å¦‚ï¼šâ€œè™½ç„¶æœ‰é»„åŒ–ï¼Œä½†å›¾åƒä¸­ç—…æ–‘è¾¹ç¼˜æœ‰æ˜æ˜¾çš„åæ­»åŒºåŸŸï¼Œè¿™ä¸å•çº¯çš„è¥å…»ç¼ºä¹ç—‡çŠ¶ä¸ç¬¦ï¼Œå› æ­¤æ’é™¤å‡è®¾Bã€‚â€
              5.  **ç»“è®ºç»¼åˆä¸æŠ¥å‘Šç”Ÿæˆ (Conclusion Synthesis & Report Generation)**: ç¡®å®šæœ€å¯ä¿¡çš„è¯Šæ–­ç»“è®ºï¼Œå¹¶æŒ‰ç…§ä¸‹æ–¹çš„å¼ºåˆ¶è¾“å‡ºç»“æ„ï¼Œå°†æ•´ä¸ªåˆ†æå’Œæ¨ç†è¿‡ç¨‹ç»„ç»‡æˆä¸€ä»½æ¡ç†æ¸…æ™°çš„æŠ¥å‘Šã€‚
          </internal_thought_process>

          <mandatory_output_structure>
              ä½ çš„å›ç­”å¿…é¡»ä¸¥æ ¼éµå¾ªä»¥ä¸‹ç»“æ„ï¼Œå¹¶ä½¿ç”¨Markdownæ ‡é¢˜ï¼š

              ### 1. æ ¸å¿ƒè¯Šæ–­ (Executive Diagnosis)
                 ç›´æ¥ç»™å‡ºæœ€å¯èƒ½çš„è¯Šæ–­ç»“è®ºã€‚

              ### 2. è§†è§‰è¯æ®åˆ†æ (Visual Evidence Analysis)
                 è¯¦ç»†æè¿°ä½ åœ¨å›¾åƒä¸­è§‚å¯Ÿåˆ°çš„å…³é”®è§†è§‰ç‰¹å¾ï¼Œå¹¶è§£é‡Šè¿™äº›ç‰¹å¾çš„ç—…ç†å­¦æˆ–ç”Ÿç†å­¦æ„ä¹‰ã€‚è¿™æ˜¯æ”¯æ’‘ä½ è¯Šæ–­ç»“è®ºçš„æ ¸å¿ƒä¾æ®ã€‚

              ### 3. è¯Šæ–­æ¨ç†è¿‡ç¨‹ (Diagnostic Reasoning)
                 å±•ç¤ºä½ çš„æ€ç»´é“¾ã€‚è¯´æ˜ä½ å¦‚ä½•åŸºäºè§†è§‰å’Œæ–‡æœ¬ä¿¡æ¯æå‡ºå‡è®¾ï¼Œå¹¶å¦‚ä½•è¿›è¡ŒéªŒè¯å’Œæ’é™¤ï¼Œæœ€ç»ˆå¾—å‡ºç»“è®ºã€‚

              ### 4. æŠ€æœ¯å»ºè®® (Technical Recommendations)
                 åŸºäºè¯Šæ–­ç»“è®ºï¼Œæä¾›é˜²æ²»ã€ç®¡ç†æˆ–è¿›ä¸€æ­¥æ£€æµ‹çš„ä¸“ä¸šå»ºè®®ã€‚

              ### 5. é‰´åˆ«è¯Šæ–­ (Differential Diagnosis)
                 ç®€è¦æåŠä¸€äº›å¯èƒ½æ··æ·†çš„ç±»ä¼¼é—®é¢˜ï¼Œå¹¶è¯´æ˜å¦‚ä½•æ ¹æ®å…³é”®ç‰¹å¾å°†å®ƒä»¬ä¸æœ€ç»ˆè¯Šæ–­åŒºåˆ†å¼€ã€‚
          </mandatory_output_structure>
      </execution_protocol>

      <golden_example>
          <user_input>
          [å›¾ç‰‡ï¼šä¸€å¼ ç•ªèŒ„å¶ç‰‡çš„æ˜¾å¾®é•œç…§ç‰‡ï¼Œæ˜¾ç¤ºå‡ºåŒå¿ƒè½®çº¹çš„åœ†å½¢è¤è‰²ç—…æ–‘ï¼Œç—…æ–‘ä¸Šæœ‰é»‘è‰²å°ç‚¹]

          è¿™æ˜¯æˆ‘ä»¬å®éªŒå®¤æ¸©å®¤æ ½åŸ¹çš„ç•ªèŒ„å¶ç‰‡ï¼Œå“ç§ä¸º'ä¸­æ‚9å·'ã€‚è¿‘æœŸæ¹¿åº¦è¾ƒé«˜ï¼Œå¶ç‰‡å‡ºç°è¿™äº›ç—…æ–‘ã€‚è¯·è¿›è¡Œè¯Šæ–­å¹¶æä¾›åˆ†ææŠ¥å‘Šã€‚
          </user_input>

          <model_output>
          ### 1. æ ¸å¿ƒè¯Šæ–­ (Executive Diagnosis)
          æ ¹æ®æä¾›çš„æ˜¾å¾®å›¾åƒåŠæè¿°ï¼Œåˆæ­¥è¯Šæ–­ä¸º**ç•ªèŒ„æ—©ç–«ç—… (Tomato Early Blight)**ï¼Œç—…åŸä¸ºèŒ„é“¾æ ¼å­¢èŒ (Alternaria solani)ã€‚

          ### 2. è§†è§‰è¯æ®åˆ†æ (Visual Evidence Analysis)
          å›¾åƒåˆ†ææ­ç¤ºäº†ä»¥ä¸‹å…³é”®ç—…ç†å­¦ç‰¹å¾ï¼š
          - **ç—…æ–‘å½¢æ€**: ç—…æ–‘å‘ˆåœ†å½¢è‡³è¿‘åœ†å½¢ï¼Œé¢œè‰²ä¸ºæ·±è¤è‰²ã€‚
          - **å…¸å‹ç—…å¾**: ç—…æ–‘ä¸Šå…·æœ‰éå¸¸æ¸…æ™°çš„ã€æ·±æµ…ç›¸é—´çš„**åŒå¿ƒè½®çº¹ (Concentric Rings)**ï¼Œè¿™æ˜¯ç•ªèŒ„æ—©ç–«ç—…çš„å…¸å‹ç‰¹å¾ï¼Œå½¢ä¼¼é¶å¿ƒã€‚
          - **äº§å­¢ç»“æ„**: åœ¨ç—…æ–‘çš„æ·±è‰²è½®çº¹ä¸Šï¼Œå¯è§å¤§é‡é»‘è‰²å°ç‚¹ï¼Œè¿™äº›æ˜¯ç—…åŸèŒçš„åˆ†ç”Ÿå­¢å­æ¢—å’Œåˆ†ç”Ÿå­¢å­ã€‚

          ### 3. è¯Šæ–­æ¨ç†è¿‡ç¨‹ (Diagnostic Reasoning)
          æˆ‘çš„è¯Šæ–­æµç¨‹å¦‚ä¸‹ï¼š
          1.  **åˆæ­¥è§‚å¯Ÿ**: å›¾åƒæ˜¾ç¤ºäº†å…·æœ‰åŒå¿ƒè½®çº¹çš„åæ­»æ€§ç—…æ–‘ã€‚æ–‡æœ¬ä¿¡æ¯æŒ‡æ˜ä½œç‰©ä¸ºç•ªèŒ„ï¼Œç¯å¢ƒæ¹¿åº¦é«˜ã€‚
          2.  **å‡è®¾ç”Ÿæˆ**: åŸºäºâ€œç•ªèŒ„â€+â€œå¶ç‰‡ç—…æ–‘â€+â€œåŒå¿ƒè½®çº¹â€è¿™ä¸‰ä¸ªæ ¸å¿ƒç‰¹å¾ï¼Œæˆ‘ç”Ÿæˆäº†é¦–è¦å‡è®¾ï¼šç•ªèŒ„æ—©ç–«ç—…ã€‚åŒæ—¶ï¼Œè€ƒè™‘äº†å…¶ä»–å¯èƒ½å¼•èµ·å¶æ–‘çš„ç—…å®³ä½œä¸ºå¤‡é€‰å‡è®¾ï¼Œå¦‚å¶éœ‰ç—…ã€æ–‘æ¯ç—…ç­‰ã€‚
          3.  **å‡è®¾éªŒè¯**: ç•ªèŒ„å¶éœ‰ç—…ä¸»è¦åœ¨å¶èƒŒäº§ç”Ÿéœ‰å±‚ï¼Œæ–‘æ¯ç—…ç—…æ–‘ä¸­å¤®å‘ˆç°ç™½è‰²ä¸”æ•£ç”Ÿå°é»‘ç‚¹ï¼Œè¿™éƒ½ä¸å›¾åƒä¸­çš„â€œé¶è½®çŠ¶â€åŒå¿ƒè½®çº¹ç‰¹å¾ä¸ç¬¦ã€‚å›¾åƒä¸­çš„ç‰¹å¾ä¸æ—©ç–«ç—…çš„å…¸å‹ç—…å¾é«˜åº¦åŒ¹é…ã€‚ç»“åˆæ–‡æœ¬ä¸­â€œæ¹¿åº¦è¾ƒé«˜â€çš„ç¯å¢ƒæ¡ä»¶ï¼Œè¿™ä¸ºå–œæ¹¿çš„é“¾æ ¼å­¢èŒä¾µæŸ“åˆ›é€ äº†æœ‰åˆ©æ¡ä»¶ã€‚å› æ­¤ï¼Œæœ€ç»ˆç¡®è®¤è¯Šæ–­ä¸ºæ—©ç–«ç—…ã€‚

          ### 4. æŠ€æœ¯å»ºè®® (Technical Recommendations)
          1.  **ç¯å¢ƒè°ƒæ§**: ç«‹å³é™ä½æ¸©å®¤æ¹¿åº¦ï¼ŒåŠ å¼ºé€šé£ï¼Œæ˜¯æ§åˆ¶ç—…å®³å‘å±•çš„å…³é”®ã€‚
          2.  **åŒ–å­¦é˜²æ²»**: å¯é€‰ç”¨ä¿æŠ¤æ€§æ€èŒå‰‚å¦‚**ä»£æ£®é”°é”Œ**æˆ–**ç™¾èŒæ¸…**è¿›è¡ŒåˆæœŸé¢„é˜²ï¼›åœ¨å‘ç—…åˆæœŸï¼Œåº”ç«‹å³å–·æ´’å†…å¸æ²»ç–—æ€§æ€èŒå‰‚ï¼Œå¦‚**è‹¯é†šç”²ç¯å”‘**ã€**å˜§èŒé…¯**æˆ–**å¼‚èŒè„²**ã€‚å»ºè®®äº¤æ›¿ä½¿ç”¨ä¸åŒä½œç”¨æœºç†çš„è¯å‰‚ï¼Œä»¥å»¶ç¼“æŠ—è¯æ€§ã€‚
          3.  **å†œä¸šé˜²æ²»**: åŠæ—¶æ¸…é™¤å¹¶é”€æ¯ç—…æ®‹ä½“ï¼Œå‡å°‘åˆä¾µæŸ“æºã€‚å®è¡Œä¸éèŒ„ç§‘ä½œç‰©è½®ä½œã€‚

          ### 5. é‰´åˆ«è¯Šæ–­ (Differential Diagnosis)
          - **ä¸æ™šç–«ç—…çš„åŒºåˆ«**: æ™šç–«ç—…ç—…æ–‘è¾¹ç¼˜ä¸æ¸…æ™°ï¼Œå‘ˆæ°´æµ¸çŠ¶ï¼Œæ¹¿åº¦å¤§æ—¶å¶èƒŒæˆ–å¶é¢ä¼šé•¿å‡ºç™½è‰²éœ‰å±‚ï¼Œä¸”æ²¡æœ‰åŒå¿ƒè½®çº¹ã€‚
          - **ä¸é¶æ–‘ç—…çš„åŒºåˆ«**: é¶æ–‘ç—…ç—…æ–‘ä¹Ÿå¯èƒ½å‡ºç°è½®çº¹ï¼Œä½†é€šå¸¸æ›´å°ï¼Œä¸”ç©¿å­”å€¾å‘æ›´æ˜æ˜¾ã€‚æ—©ç–«ç—…çš„è½®çº¹å’Œâ€œé¶å¿ƒâ€ç‰¹å¾æ›´ä¸ºå…¸å‹ã€‚
          </model_output>
      </golden_example>

      </prompt>`,
        };

        return prompts[utype] || prompts[0];
      }

      async function callOllamaAPI(message, utype = 0, images = []) {
        try {
          const systemPrompt = getSystemPromptByUserType(utype);

          const requestBody = {
            model: OLLAMA_CONFIG.model,
            system: systemPrompt,
            prompt: message,
            images: images,
            stream: false,
            options: {
              temperature: 0.7,
              top_p: 0.9,
              top_k: 40,
            },
          };

          console.log("å‘é€åˆ°Ollamaçš„è¯·æ±‚:", requestBody);

          const response = await fetch(`${OLLAMA_CONFIG.baseUrl}/api/chat`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(requestBody),
          });

          if (!response.ok) {
            throw new Error(
              `Ollama APIè°ƒç”¨å¤±è´¥: ${response.status} ${response.statusText}`
            );
          }

          const data = await response.json();
          console.log("Ollamaè¿”å›æ•°æ®:", data);

          return data.message?.content || "æŠ±æ­‰ï¼ŒAIåŠ©æ‰‹æš‚æ—¶æ— æ³•å›å¤ã€‚";
        } catch (error) {
          console.error("Ollama APIè°ƒç”¨é”™è¯¯:", error);
          throw new Error("AIæœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·æ£€æŸ¥OllamaæœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œã€‚");
        }
      }

      async function generateAIResponse(message, utype = null) {
        // å¦‚æœæ²¡æœ‰ä¼ å…¥utypeï¼Œä½¿ç”¨å½“å‰ç”¨æˆ·çš„ç±»å‹
        const userType = utype !== null ? utype : currentUser.utype;

        try {
          return await callOllamaAPI(message, userType);
        } catch (error) {
          console.error("AIå›å¤ç”Ÿæˆå¤±è´¥:", error);
          throw new Error("AIåŠ©æ‰‹æš‚æ—¶æ— æ³•å›å¤ï¼Œè¯·æ£€æŸ¥OllamaæœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œã€‚");
        }
      }
      // å¦‚æœimageFileä¸ºå›¾ç‰‡,éœ€è¦è½¬åŒ–ä¸ºbase64æ ¼å¼
      async function generateAIResponseWithImage(message, imageFile) {
        const reader = new FileReader();
        reader.readAsDataURL(imageFile);
        reader.onload = async () => {
          const base64Image = reader.result.split(",")[1];
          const response = await callOllamaAPI(message, {
            images: [base64Image],
          });
          return response;
        };
      }

      function formatDate(timestamp) {
        const date = new Date(timestamp);
        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / 60000);

        if (diffMins < 1) return "åˆšåˆš";
        if (diffMins < 60) return `${diffMins}åˆ†é’Ÿå‰`;
        if (diffMins < 1440) return `${Math.floor(diffMins / 60)}å°æ—¶å‰`;

        return date.toLocaleDateString("zh-CN", {
          month: "short",
          day: "numeric",
          hour: "2-digit",
          minute: "2-digit",
        });
      }

      // --- Event Listeners ---
      document.addEventListener("DOMContentLoaded", function () {
        // è¾“å…¥æ¡†äº‹ä»¶
        const fullInput = getEl("aiFullInput");
        if (fullInput) {
          fullInput.addEventListener("input", (e) =>
            adjustTextareaHeight(e.target)
          );
          fullInput.addEventListener("keydown", (e) => {
            if (e.key === "Enter" && !e.shiftKey) {
              e.preventDefault();
              sendFullMessage();
            }
          });
        }

        const miniInput = getEl("aiMiniInput");
        if (miniInput) {
          miniInput.addEventListener("keydown", (e) => {
            if (e.key === "Enter") {
              e.preventDefault();
              sendMiniMessage();
            }
          });
        }

        // æ–‡ä»¶ä¸Šä¼ äº‹ä»¶
        const uploadArea = getEl("aiUploadArea");
        if (uploadArea) {
          uploadArea.addEventListener("click", () => {
            getEl("fullFileInput").click();
          });

          uploadArea.addEventListener("dragover", (e) => {
            e.preventDefault();
            uploadArea.classList.add("dragover");
          });

          uploadArea.addEventListener("dragleave", (e) => {
            e.preventDefault();
            uploadArea.classList.remove("dragover");
          });

          uploadArea.addEventListener("drop", (e) => {
            e.preventDefault();
            uploadArea.classList.remove("dragover");
            addFilesToUploadList(e.dataTransfer.files);
          });
        }

        // é¡µé¢å¸è½½å‰ä¿å­˜
        window.addEventListener("beforeunload", saveCurrentSession);
      });
    </script>

    <!-- åœ¨é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–å›¾æ ‡ -->
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        lucide.createIcons();
      });
    </script>
  </body>
</html>
